<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title></title>
    <style>
      body {
        text-align: center;
        font-family: sans-serif;
        font-size: 5rem;
        font-weight: bold;
        color: #FFF;
        opacity: .65;
      }
      .square {
        height: 40px;
        width: 40px;
        background: #FFF;
        display: inline-block;
        margin: 1rem;
        opacity: .65;
      }
      .result {
        /*text-shadow: #000000 1px 1px 1px, #ffffff -1px -1px 1px;*/
      }
    </style>
  </head>
  <body>
  <div class="square square1"></div>
  <div class="square square2"></div>
  <div class="square square3"></div>
  <div class="result"></div>
  <script type="text/javascript">
    // window.addEventListener("deviceorientation", (e) => console.log(e), true);
    // window.ondevicemotionevent = (e) => console.log(e)
  </script>
  <script src="$SOCKET_SERVER/socket.io/socket.io.js"></script>
  <script>
    // TODO: Scope these
    let r,g,b;

    // SHARED SETUP
    const socket = io('$SOCKET_SERVER');
    console.log(socket);
    socket.on('connect', function(){  console.log('connected');});
    socket.on('disconnect', function(){});

    // DESKTOP ONLY
    socket.on('update', renderFromOrientationData);

    // MOBILE ONLY
    // TODO: check for mobile device
    window.ondeviceorientation = (e) => {
      const { alpha, beta, gamma } = e;
      renderFromOrientationData(e);
      socket.emit('update', { alpha, beta, gamma });
    }

    // shared functionality
    socket.on('tap', updateColorSelection);

    document.addEventListener('click', () => {
      updateColorSelection();
      socket.emit('tap');
    });

    // shared functions
    const proportion = (a,b,c) => a*b/c;
    const valueFromBeta = (v) => proportion(v, 255, 180);
    const valueFromGamma = (v) => proportion(v, 255, 90);
    const valueFromAlpha = (v) => proportion(v, 255, 360);
    const toHex = (num) => `0${num.toString(16)}`.slice(-2).toUpperCase();

    const rgbFromOrientation = (alpha, beta, gamma) =>
      [
        Math.round(valueFromAlpha(Math.abs(alpha))),
        Math.round(valueFromBeta(Math.abs(beta))),
        Math.round(valueFromGamma(Math.abs(gamma)))
      ]

    function renderFromOrientationData(data) {
      const { alpha, beta, gamma } = data;
      [r, g, b] = rgbFromOrientation(alpha, beta, gamma);
      updateSquares(alpha, beta, gamma);
      updateColor(alpha, beta, gamma);
    }
    // DOM stuff
    const $body = document.querySelector('body');
    const $result = document.querySelector('.result');

    function updateColor(){
      $body.style.background = `rgb(${r}, ${g}, ${b})`;
    }

    function updateColorSelection(){
      $result.style.color = `rgb(${r}, ${g}, ${b})`;
      $result.innerText = "#" + toHex(r) + toHex(g) + toHex(b);
    }

    function updateSquares(alpha, beta, gamma){
      document.querySelector('.square1').style.transform = `rotate(${alpha}deg)`;
      document.querySelector('.square2').style.transform = `rotate(${beta}deg)`;
      document.querySelector('.square3').style.transform = `rotate(${gamma}deg)`;
    }

  </script>
  </body>
</html>
